#!/bin/bash

# âœ… í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
AWS_REGION="ap-northeast-2"
CLUSTER_NAME="ott-eks"
ACCOUNT_ID="979202697408"
ROLE_NAME="AmazonEKS_AWSLoadBalancerControllerRole-${CLUSTER_NAME}"

# Create bin directory
sudo -u ec2-user mkdir -p /home/ec2-user/bin

# Download kubectl
curl -LO "https://dl.k8s.io/release/v1.27.4/bin/linux/amd64/kubectl"
chmod +x kubectl
mv kubectl /home/ec2-user/bin/kubectl
chown ec2-user:ec2-user /home/ec2-user/bin/kubectl

# ì§ì ‘ PATH ì„¤ì • (bashrc ì ìš© ê¸°ë‹¤ë¦´ í•„ìš” ì—†ì´)
export PATH=/home/ec2-user/bin:$PATH

# âœ… AWS CLI ì„¤ì • (admin í”„ë¡œíŒŒì¼)
sudo -u ec2-user aws configure set aws_access_key_id "${ACCESS_KEY}" --profile admin
sudo -u ec2-user aws configure set aws_secret_access_key "${SECRET_KEY}" --profile admin
sudo -u ec2-user aws configure set region $AWS_REGION --profile admin

# âœ… kubeconfig ì„¤ì •
sudo -u ec2-user aws eks update-kubeconfig --region $AWS_REGION --name $CLUSTER_NAME --profile admin

# ---------------------------------------
# âœ… Argo CD ì„¤ì¹˜
# ---------------------------------------
sudo -u ec2-user /home/ec2-user/bin/kubectl create namespace argocd

sudo -u ec2-user /home/ec2-user/bin/kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml

# âœ… ArgoCD ì„œë²„ ë…¸ì¶œ (LoadBalancer)
sudo -u ec2-user /home/ec2-user/bin/kubectl patch svc argocd-server -n argocd -p '{"spec": {"type": "LoadBalancer"}}'

echo "ğŸ‰ Argo CD ì„¤ì¹˜ ì™„ë£Œ. ì ì‹œ í›„ LoadBalancer ì£¼ì†Œê°€ ë°œê¸‰ë©ë‹ˆë‹¤."

# ---------------------------------------
# âœ… Argo CD App: React Frontend ë°°í¬ìš©
# ---------------------------------------
cat <<EOF > /home/ec2-user/ott-project-app.yml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: frontend
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://github.com/caZaDoRa255/AWS2ndProject
    targetRevision: main
    path: ott-project/manifests/k8s
  destination:
    server: https://kubernetes.default.svc
    namespace: frontend
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
EOF

sudo -u ec2-user /home/ec2-user/bin/kubectl apply -f /home/ec2-user/ott-project-app.yml -n argocd

# ---------------------------------------
# âœ… Argo CD App: AWS Load Balancer Controller (Helm)
# ---------------------------------------
cat <<EOF > /home/ec2-user/alb-controller-app.yml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: aws-load-balancer-controller
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://aws.github.io/eks-charts
    targetRevision: 1.13.2
    chart: aws-load-balancer-controller
    helm:
      values: |
        clusterName: ${CLUSTER_NAME}
        serviceAccount:
          create: true
          name: aws-load-balancer-controller
          annotations:
            eks.amazonaws.com/role-arn: "arn:aws:iam::${ACCOUNT_ID}:role/${ROLE_NAME}"
        image:
          repository: 602401143452.dkr.ecr.ap-northeast-2.amazonaws.com/amazon/aws-load-balancer-controller
        region: ${AWS_REGION}
        watchNamespace: "" # ëª¨ë“  ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê°ì‹œ
  destination:
    server: https://kubernetes.default.svc
    namespace: kube-system
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
EOF

sudo -u ec2-user /home/ec2-user/bin/kubectl apply -f /home/ec2-user/alb-controller-app.yml -n argocd

echo "ğŸ‰ AWS Load Balancer Controller Argo CD Application ì„¤ì¹˜ ì™„ë£Œ."
