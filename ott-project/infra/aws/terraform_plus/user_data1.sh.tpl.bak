#!/bin/bash

ACCESS_KEY="${ACCESS_KEY}"
SECRET_KEY="${SECRET_KEY}"


# AWS CLI configure
sudo -u ec2-user aws configure set aws_access_key_id "${ACCESS_KEY}" --profile admin
sudo -u ec2-user aws configure set aws_secret_access_key "${SECRET_KEY}" --profile admin
sudo -u ec2-user aws configure set region ap-northeast-2 --profile admin

# Create bin directory and move kubectl there
sudo -u ec2-user mkdir -p /home/ec2-user/bin

# Download kubectl
sudo curl -O  https://s3.ap-northeast-2.amazonaws.com/amazon-eks/1.32.0/2024-12-20/bin/linux/amd64/kubectl

# File Move
sudo mv /kubectl /home/ec2-user/bin/kubectl 

# Make kubectl executable
sudo chown ec2-user:ec2-user /home/ec2-user/bin/kubectl
sudo chmod +x /home/ec2-user/bin/kubectl

# Update kubeconfig for EKS
sudo -u ec2-user aws eks update-kubeconfig --region ap-northeast-2 --name ott-eks --profile admin

#-----------------------------------------------------------------------------------------------------


# Argo CD ì„¤ì¹˜ ìë™í™”

# Argo CD namespace ìƒì„±
sudo -u ec2-user /home/ec2-user/bin/kubectl create namespace argocd

# Argo CD ì„¤ì¹˜
sudo -u ec2-user /home/ec2-user/bin/kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml

# Argo CD ì„œë²„ ì„œë¹„ìŠ¤ íƒ€ì… LoadBalancerë¡œ ë³€ê²½
sudo -u ec2-user /home/ec2-user/bin/kubectl patch svc argocd-server -n argocd -p '{"spec": {"type": "LoadBalancer"}}'

echo "ğŸ‰ Argo CD ì„¤ì¹˜ ì™„ë£Œ. ì ì‹œ í›„ LoadBalancer ì£¼ì†Œê°€ ë°œê¸‰ë©ë‹ˆë‹¤."



#-------------------------------------------------------------------

# ott-project-app.yml ìƒì„±
cat <<EOF > /home/ec2-user/ott-project-app.yml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: frontend
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://github.com/caZaDoRa255/AWS2ndProject
    targetRevision: main
    path: ott-project/manifests/k8s
    # ì œê°€ path ê³ ì³¤ì–´ìš” ì˜í–ˆì£ ?
  destination:
    server: https://kubernetes.default.svc
    namespace: frontend
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
EOF



# ì ìš©
sudo -u ec2-user /home/ec2-user/bin/kubectl apply -f /home/ec2-user/ott-project-app.yml -n argocd


#-------------------------------------------------------------------

# AWS Load Balancer Controller Argo CD Application ìƒì„± ë° ì ìš©
# ì´ ë¶€ë¶„ì€ ALB Controllerë¥¼ Argo CDë¡œ ê´€ë¦¬í•˜ê¸° ìœ„í•œ ì„¤ì •ì…ë‹ˆë‹¤.
# !!! ì¤‘ìš”: 'eks.amazonaws.com/role-arn' ë¶€ë¶„ì˜ ARNì„ ì‹¤ì œ Terraformì´ ìƒì„±í•  ARNìœ¼ë¡œ êµì²´í•´ì•¼ í•©ë‹ˆë‹¤.
#          (<YOUR_AWS_ACCOUNT_ID> ë¶€ë¶„ì„ ë‹¹ì‹ ì˜ AWS ê³„ì • IDë¡œ ë³€ê²½í•˜ê³ ,
#           'AmazonEKS_AWSLoadBalancerControllerRole-ott-eks'ê°€ Terraformì—ì„œ ìƒì„±í•œ IAM Role ì´ë¦„ê³¼ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.)
#          <ìµœì‹  ë²„ì „> ë¶€ë¶„ë„ ALB Controller Helm Chartì˜ ìµœì‹  ì•ˆì • ë²„ì „ìœ¼ë¡œ êµì²´í•´ì•¼ í•©ë‹ˆë‹¤. (ì˜ˆ: 1.6.2)
cat <<EOF > /home/ec2-user/alb-controller-app.yml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: aws-load-balancer-controller
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://aws.github.io/eks-charts # ALB Controller Helm Chart Repository
    targetRevision: 1.13.2
    chart: aws-load-balancer-controller
    helm:
      values: |
        clusterName: ott-eks
        serviceAccount:
          create: true
          name: aws-load-balancer-controller
          annotations:
            eks.amazonaws.com/role-arn: "arn:aws:iam::979202697408:role/AmazonEKS_AWSLoadBalancerControllerRole-ott-eks"
        image:
          repository: 602401143452.dkr.ecr.ap-northeast-2.amazonaws.com/amazon/aws-load-balancer-controller
        region: ap-northeast-2
        ALB Controllerê°€ ëª¨ë“  ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì˜ Ingressë¥¼ ê°ì§€í•˜ë„ë¡ ì„¤ì • (ê¶Œì¥)
        watchNamespace: "" # ì´ ì£¼ì„ì„ í•´ì œí•˜ê±°ë‚˜ ì´ ì¤„ì„ ì—†ì• ë©´ ê¸°ë³¸ì ìœ¼ë¡œ ëª¨ë“  ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê°ì§€
  destination:
    server: https://kubernetes.default.svc
    namespace: kube-system # ALB ControllerëŠ” ì¼ë°˜ì ìœ¼ë¡œ kube-system ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ì„¤ì¹˜ë©ë‹ˆë‹¤.
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true # kube-systemì€ ë³´í†µ ìˆì§€ë§Œ, ì•ˆì „ì„ ìœ„í•´ ì¶”ê°€
EOF

# AWS Load Balancer Controller Argo CD Application ì ìš©
sudo -u ec2-user /home/ec2-user/bin/kubectl apply -f /home/ec2-user/alb-controller-app.yml -n argocd

echo "ğŸ‰ AWS Load Balancer Controller Argo CD Application ì„¤ì¹˜ ì™„ë£Œ."

#-------------------------------------------------------------------